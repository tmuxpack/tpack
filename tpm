#!/usr/bin/env bash

# TPM - Tmux Plugin Manager
#
# This is the backward-compatible shell shim. It detects the Go binary
# (tpm-go) and delegates to it. If the Go binary is not found, it falls
# back to the original bash implementation.

CURRENT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

# Detect the Go binary. Search order:
# 1. dist/tpm-go (development build)
# 2. tpm-go alongside this script
# 3. tpm-go in PATH
_find_tpm_go() {
	if [ -x "$CURRENT_DIR/dist/tpm-go" ]; then
		echo "$CURRENT_DIR/dist/tpm-go"
		return
	fi
	if [ -x "$CURRENT_DIR/tpm-go" ]; then
		echo "$CURRENT_DIR/tpm-go"
		return
	fi
	if command -v tpm-go >/dev/null 2>&1; then
		command -v tpm-go
		return
	fi
}

TPM_GO="$(_find_tpm_go)"

if [ -n "$TPM_GO" ]; then
	exec "$TPM_GO" init "$@"
fi

# Fallback: original bash implementation
BINDINGS_DIR="$CURRENT_DIR/bindings"
SCRIPTS_DIR="$CURRENT_DIR/scripts"

source "$SCRIPTS_DIR/variables.sh"

get_tmux_option() {
	local option="$1"
	local default_value="$2"
	local option_value="$(tmux show-option -gqv "$option")"
	if [ -z "$option_value" ]; then
		echo "$default_value"
	else
		echo "$option_value"
	fi
}

tpm_path_set() {
	tmux show-environment -g "$DEFAULT_TPM_ENV_VAR_NAME" >/dev/null 2>&1
}

set_default_tpm_path() {
	local xdg_tmux_path="${XDG_CONFIG_HOME:-$HOME/.config}/tmux"
	local tpm_path="$DEFAULT_TPM_PATH"

	if [ -f "$xdg_tmux_path/tmux.conf" ]; then
		tpm_path="$xdg_tmux_path/plugins/"
	fi

	tmux set-environment -g "$DEFAULT_TPM_ENV_VAR_NAME" "$tpm_path"
}

set_tpm_path() {
	if ! tpm_path_set; then
		set_default_tpm_path
	fi
}

source_plugins() {
	"$SCRIPTS_DIR/source_plugins.sh" >/dev/null 2>&1
}

set_tpm_key_bindings() {
	local install_key="$(get_tmux_option "$install_key_option" "$default_install_key")"
	tmux bind-key "$install_key" run-shell "$BINDINGS_DIR/install_plugins"

	local update_key="$(get_tmux_option "$update_key_option" "$default_update_key")"
	tmux bind-key "$update_key" run-shell "$BINDINGS_DIR/update_plugins"

	local clean_key="$(get_tmux_option "$clean_key_option" "$default_clean_key")"
	tmux bind-key "$clean_key" run-shell "$BINDINGS_DIR/clean_plugins"
}

supported_tmux_version_ok() {
	"$SCRIPTS_DIR/check_tmux_version.sh" "$SUPPORTED_TMUX_VERSION"
}

main() {
	if supported_tmux_version_ok; then
		set_tpm_path
		set_tpm_key_bindings
		source_plugins
	fi
}
main
